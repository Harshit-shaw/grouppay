import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { Link } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
  DialogFooter } from
"@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue } from
"@/components/ui/select";
import {
  Plus,
  Users as UsersIcon,
  ArrowRight,
  Plane,
  Home as HomeIcon,
  Cake,
  Briefcase,
  Coffee,
  ShoppingBag,
  Heart,
  Copy,
  Check } from
"lucide-react";
import { motion } from "framer-motion";

const iconOptions = [
{ value: "plane", label: "Travel", icon: Plane },
{ value: "home", label: "Home", icon: HomeIcon },
{ value: "cake", label: "Party", icon: Cake },
{ value: "briefcase", label: "Work", icon: Briefcase },
{ value: "users", label: "Friends", icon: UsersIcon },
{ value: "coffee", label: "Coffee", icon: Coffee },
{ value: "shopping", label: "Shopping", icon: ShoppingBag },
{ value: "heart", label: "Other", icon: Heart }];


const iconMap = {
  plane: Plane,
  home: HomeIcon,
  cake: Cake,
  briefcase: Briefcase,
  users: UsersIcon,
  coffee: Coffee,
  shopping: ShoppingBag,
  heart: Heart
};

export default function Groups() {
  const [user, setUser] = useState(null);
  const [showCreateDialog, setShowCreateDialog] = useState(false);
  const [showJoinDialog, setShowJoinDialog] = useState(false);
  const [joinCode, setJoinCode] = useState("");
  const [copiedCode, setCopiedCode] = useState(null);
  const [newGroup, setNewGroup] = useState({
    name: "",
    description: "",
    icon: "users"
  });

  const queryClient = useQueryClient();

  useEffect(() => {
    base44.auth.me().then(setUser).catch(() => {});
  }, []);

  const { data: groups = [], isLoading } = useQuery({
    queryKey: ['groups'],
    queryFn: () => base44.entities.Group.list('-updated_date'),
    enabled: !!user
  });

  const createGroupMutation = useMutation({
    mutationFn: async (groupData) => {
      const inviteCode = Math.random().toString(36).substring(2, 10).toUpperCase();
      return base44.entities.Group.create({
        ...groupData,
        invite_code: inviteCode,
        members: [user.email]
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['groups']);
      setShowCreateDialog(false);
      setNewGroup({ name: "", description: "", icon: "users" });
    }
  });

  const joinGroupMutation = useMutation({
    mutationFn: async (code) => {
      const [group] = await base44.entities.Group.filter({ invite_code: code.toUpperCase() });
      if (!group) throw new Error("Invalid invite code");

      const updatedMembers = [...(group.members || []), user.email];
      await base44.entities.Group.update(group.id, { members: updatedMembers });
      return group;
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['groups']);
      setShowJoinDialog(false);
      setJoinCode("");
    }
  });

  const handleCreateGroup = () => {
    if (!newGroup.name.trim()) return;
    createGroupMutation.mutate(newGroup);
  };

  const handleJoinGroup = () => {
    if (!joinCode.trim()) return;
    joinGroupMutation.mutate(joinCode);
  };

  const copyInviteCode = (code) => {
    navigator.clipboard.writeText(code);
    setCopiedCode(code);
    setTimeout(() => setCopiedCode(null), 2000);
  };

  return (
    <div className="min-h-screen p-4 md:p-8 pb-24 md:pb-8">
      <div className="max-w-6xl mx-auto">
        {/* Header */}
        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
          <div>
            <h1 className="text-3xl md:text-4xl font-bold text-gray-900 mb-2">My Groups</h1>
            <p className="text-gray-600">Manage your expense groups</p>
          </div>
          <div className="flex gap-3 w-full md:w-auto">
            <Dialog open={showJoinDialog} onOpenChange={setShowJoinDialog}>
              <DialogTrigger asChild>
                <Button variant="outline" className="flex-1 md:flex-none">
                  Join Group
                </Button>
              </DialogTrigger>
              <DialogContent>
                <DialogHeader>
                  <DialogTitle>Join a Group</DialogTitle>
                </DialogHeader>
                <div className="space-y-4 py-4">
                  <div>
                    <Label>Invite Code</Label>
                    <Input
                      placeholder="Enter invite code"
                      value={joinCode}
                      onChange={(e) => setJoinCode(e.target.value.toUpperCase())}
                      className="uppercase" />

                  </div>
                </div>
                <DialogFooter>
                  <Button onClick={handleJoinGroup} disabled={!joinCode.trim()}>
                    Join Group
                  </Button>
                </DialogFooter>
              </DialogContent>
            </Dialog>

            <Dialog open={showCreateDialog} onOpenChange={setShowCreateDialog}>
              <DialogTrigger asChild>
                <Button className="flex-1 md:flex-none bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 shadow-md">
                  <Plus className="w-4 h-4 mr-2" />
                  Create Group
                </Button>
              </DialogTrigger>
              <DialogContent className="bg-neutral-100 p-6 fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg">
                <DialogHeader>
                  <DialogTitle>Create New Group</DialogTitle>
                </DialogHeader>
                <div className="space-y-4 py-4">
                  <div>
                    <Label>Group Name</Label>
                    <Input
                      placeholder="e.g., Goa Trip, Room 203"
                      value={newGroup.name}
                      onChange={(e) => setNewGroup({ ...newGroup, name: e.target.value })} />

                  </div>
                  <div>
                    <Label>Description (optional)</Label>
                    <Textarea
                      placeholder="What's this group for?"
                      value={newGroup.description}
                      onChange={(e) => setNewGroup({ ...newGroup, description: e.target.value })} />

                  </div>
                  <div>
                    <Label>Icon</Label>
                    <Select value={newGroup.icon} onValueChange={(value) => setNewGroup({ ...newGroup, icon: value })}>
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        {iconOptions.map((option) => {
                          const Icon = option.icon;
                          return (
                            <SelectItem key={option.value} value={option.value}>
                              <div className="flex items-center gap-2">
                                <Icon className="w-4 h-4" />
                                {option.label}
                              </div>
                            </SelectItem>);

                        })}
                      </SelectContent>
                    </Select>
                  </div>
                </div>
                <DialogFooter>
                  <Button onClick={handleCreateGroup} disabled={!newGroup.name.trim()}>
                    Create Group
                  </Button>
                </DialogFooter>
              </DialogContent>
            </Dialog>
          </div>
        </div>

        {/* Groups Grid */}
        {isLoading ?
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {[1, 2, 3, 4, 5, 6].map((i) =>
          <div key={i} className="h-48 bg-gray-100 animate-pulse rounded-2xl" />
          )}
          </div> :
        groups.length === 0 ?
        <Card className="border-2 border-dashed border-gray-300">
            <CardContent className="flex flex-col items-center justify-center py-16">
              <div className="w-20 h-20 bg-gradient-to-br from-cyan-100 to-blue-100 rounded-full flex items-center justify-center mb-4">
                <UsersIcon className="w-10 h-10 text-cyan-600" />
              </div>
              <h3 className="text-xl font-semibold text-gray-900 mb-2">No groups yet</h3>
              <p className="text-gray-500 mb-6 text-center max-w-sm">
                Create your first group to start splitting expenses with friends
              </p>
              <Button
              onClick={() => setShowCreateDialog(true)}
              className="bg-gradient-to-r from-cyan-500 to-blue-600">

                <Plus className="w-4 h-4 mr-2" />
                Create Your First Group
              </Button>
            </CardContent>
          </Card> :

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {groups.map((group, index) => {
            const Icon = iconMap[group.icon] || UsersIcon;
            return (
              <motion.div
                key={group.id}
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ delay: index * 0.1 }}>

                  <Card className="hover:shadow-xl transition-all cursor-pointer border-0 shadow-md group overflow-hidden">
                    <div className="h-2 bg-gradient-to-r from-cyan-500 to-blue-600" />
                    <CardContent className="p-6">
                      <div className="flex items-start justify-between mb-4">
                        <div className="p-4 bg-gradient-to-br from-cyan-100 to-blue-100 rounded-2xl group-hover:scale-110 transition-transform">
                          <Icon className="w-8 h-8 text-cyan-600" />
                        </div>
                        <Link to={`${createPageUrl("GroupDetail")}?id=${group.id}`}>
                          <Button variant="ghost" size="icon" className="group-hover:bg-cyan-50">
                            <ArrowRight className="w-5 h-5 text-gray-400 group-hover:text-cyan-600 group-hover:translate-x-1 transition-all" />
                          </Button>
                        </Link>
                      </div>
                      <h3 className="text-xl font-bold text-gray-900 mb-2">{group.name}</h3>
                      <p className="text-sm text-gray-500 mb-4 line-clamp-2 min-h-[2.5rem]">
                        {group.description || "No description"}
                      </p>
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2 text-sm text-gray-600">
                          <UsersIcon className="w-4 h-4" />
                          <span>{group.members?.length || 0} members</span>
                        </div>
                        <Button
                        variant="ghost"
                        size="sm"
                        onClick={(e) => {
                          e.stopPropagation();
                          copyInviteCode(group.invite_code);
                        }}
                        className="text-xs">

                          {copiedCode === group.invite_code ?
                        <>
                              <Check className="w-3 h-3 mr-1" />
                              Copied
                            </> :

                        <>
                              <Copy className="w-3 h-3 mr-1" />
                              Invite
                            </>
                        }
                        </Button>
                      </div>
                    </CardContent>
                  </Card>
                </motion.div>);

          })}
          </div>
        }
      </div>
    </div>);

}
