import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Avatar, AvatarFallback } from "@/components/ui/avatar";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
  DialogFooter } from
"@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue } from
"@/components/ui/select";
import {
  Plus,
  ArrowLeft,
  Users,
  Copy,
  Check,
  Receipt,
  Image as ImageIcon,
  X } from
"lucide-react";
import { Link } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { motion } from "framer-motion";

const categoryColors = {
  food: "bg-orange-100 text-orange-800",
  lodging: "bg-purple-100 text-purple-800",
  transport: "bg-blue-100 text-blue-800",
  entertainment: "bg-pink-100 text-pink-800",
  shopping: "bg-green-100 text-green-800",
  utilities: "bg-yellow-100 text-yellow-800",
  other: "bg-gray-100 text-gray-800"
};

export default function GroupDetail() {
  const [user, setUser] = useState(null);
  const [copiedCode, setCopiedCode] = useState(false);
  const [showAddExpense, setShowAddExpense] = useState(false);
  const [uploadingPhoto, setUploadingPhoto] = useState(false);
  const [newExpense, setNewExpense] = useState({
    title: "",
    amount: "",
    category: "other",
    date: new Date().toISOString().split('T')[0],
    notes: "",
    photo_url: "",
    split_type: "equal"
  });

  const urlParams = new URLSearchParams(window.location.search);
  const groupId = urlParams.get('id');
  const queryClient = useQueryClient();

  useEffect(() => {
    base44.auth.me().then(setUser).catch(() => {});
  }, []);

  const { data: group, isLoading: groupLoading } = useQuery({
    queryKey: ['group', groupId],
    queryFn: async () => {
      const groups = await base44.entities.Group.filter({ id: groupId });
      return groups[0];
    },
    enabled: !!groupId
  });

  const { data: expenses = [], isLoading: expensesLoading } = useQuery({
    queryKey: ['groupExpenses', groupId],
    queryFn: () => base44.entities.Expense.filter({ group_id: groupId }, '-date'),
    enabled: !!groupId
  });

  const createExpenseMutation = useMutation({
    mutationFn: async (expenseData) => {
      const participants = group.members.map((email) => ({
        email,
        share: 1
      }));

      return base44.entities.Expense.create({
        ...expenseData,
        group_id: groupId,
        paid_by: user.email,
        participants
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['groupExpenses', groupId]);
      setShowAddExpense(false);
      setNewExpense({
        title: "",
        amount: "",
        category: "other",
        date: new Date().toISOString().split('T')[0],
        notes: "",
        photo_url: "",
        split_type: "equal"
      });
    }
  });

  const handlePhotoUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    setUploadingPhoto(true);
    try {
      const { file_url } = await base44.integrations.Core.UploadFile({ file });
      setNewExpense({ ...newExpense, photo_url: file_url });
    } catch (error) {
      console.error("Error uploading photo:", error);
    }
    setUploadingPhoto(false);
  };

  const handleAddExpense = () => {
    if (!newExpense.title.trim() || !newExpense.amount) return;
    createExpenseMutation.mutate({
      ...newExpense,
      amount: parseFloat(newExpense.amount)
    });
  };

  const calculateBalances = () => {
    const balances = {};

    expenses.forEach((expense) => {
      if (!expense.participants || expense.participants.length === 0) return;

      const totalShares = expense.participants.reduce((sum, p) => sum + (p.share || 0), 0);

      expense.participants.forEach((participant) => {
        const share = participant.share / totalShares * expense.amount;

        if (!balances[participant.email]) {
          balances[participant.email] = { owes: {}, owed: {} };
        }

        if (participant.email === expense.paid_by) {
          // This person paid, so others owe them
          expense.participants.forEach((other) => {
            if (other.email !== participant.email) {
              const otherShare = other.share / totalShares * expense.amount;
              if (!balances[participant.email].owed[other.email]) {
                balances[participant.email].owed[other.email] = 0;
              }
              balances[participant.email].owed[other.email] += otherShare;
            }
          });
        } else {
          // This person owes the payer
          if (!balances[participant.email].owes[expense.paid_by]) {
            balances[participant.email].owes[expense.paid_by] = 0;
          }
          balances[participant.email].owes[expense.paid_by] += share;
        }
      });
    });

    return balances;
  };

  const balances = calculateBalances();
  const myBalance = user ? balances[user.email] || { owes: {}, owed: {} } : { owes: {}, owed: {} };

  const copyInviteCode = () => {
    if (group?.invite_code) {
      navigator.clipboard.writeText(group.invite_code);
      setCopiedCode(true);
      setTimeout(() => setCopiedCode(false), 2000);
    }
  };

  if (groupLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-600" />
      </div>);

  }

  if (!group) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <p className="text-gray-500 mb-4">Group not found</p>
          <Link to={createPageUrl("Groups")}>
            <Button>Back to Groups</Button>
          </Link>
        </div>
      </div>);

  }

  const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);

  return (
    <div className="min-h-screen p-4 md:p-8 pb-24 md:pb-8">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="flex items-center gap-4 mb-6">
          <Link to={createPageUrl("Groups")}>
            <Button variant="outline" size="icon">
              <ArrowLeft className="w-4 h-4" />
            </Button>
          </Link>
          <div className="flex-1">
            <h1 className="text-2xl md:text-3xl font-bold text-gray-900">{group.name}</h1>
            <p className="text-gray-600 text-sm mt-1">{group.description || "No description"}</p>
          </div>
        </div>

        {/* Group Info & Actions */}
        <div className="grid md:grid-cols-3 gap-4 mb-8">
          <Card className="bg-gradient-to-br from-cyan-500 to-blue-600 text-white border-0">
            <CardContent className="p-6">
              <p className="text-sm opacity-90 mb-1">Total Spent</p>
              <h3 className="text-3xl font-bold">${totalExpenses.toFixed(2)}</h3>
            </CardContent>
          </Card>

          <Card className="bg-gradient-to-br from-green-500 to-emerald-600 text-white border-0">
            <CardContent className="p-6">
              <p className="text-sm opacity-90 mb-1">You're Owed</p>
              <h3 className="text-3xl font-bold">
                ${Object.values(myBalance.owed).reduce((sum, amt) => sum + amt, 0).toFixed(2)}
              </h3>
            </CardContent>
          </Card>

          <Card className="bg-gradient-to-br from-orange-500 to-red-500 text-white border-0">
            <CardContent className="p-6">
              <p className="text-sm opacity-90 mb-1">You Owe</p>
              <h3 className="text-3xl font-bold">
                ${Object.values(myBalance.owes).reduce((sum, amt) => sum + amt, 0).toFixed(2)}
              </h3>
            </CardContent>
          </Card>
        </div>

        <div className="grid lg:grid-cols-3 gap-6">
          {/* Expenses List */}
          <div className="lg:col-span-2">
            <Card className="shadow-md border-0">
              <CardHeader className="flex flex-row items-center justify-between">
                <CardTitle>Expenses</CardTitle>
                <Dialog open={showAddExpense} onOpenChange={setShowAddExpense}>
                  <DialogTrigger asChild>
                    <Button className="bg-gradient-to-r from-cyan-500 to-blue-600">
                      <Plus className="w-4 h-4 mr-2" />
                      Add Expense
                    </Button>
                  </DialogTrigger>
                  <DialogContent className="bg-slate-100 p-6 fixed left-[50%] top-[50%] z-50 grid w-full translate-x-[-50%] translate-y-[-50%] gap-4 border shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg max-w-md">
                    <DialogHeader>
                      <DialogTitle>Add New Expense</DialogTitle>
                    </DialogHeader>
                    <div className="space-y-4 py-4">
                      <div>
                        <Label>Title</Label>
                        <Input
                          placeholder="e.g., Dinner at restaurant"
                          value={newExpense.title}
                          onChange={(e) => setNewExpense({ ...newExpense, title: e.target.value })} />

                      </div>
                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <Label>Amount</Label>
                          <Input
                            type="number"
                            placeholder="0.00"
                            value={newExpense.amount}
                            onChange={(e) => setNewExpense({ ...newExpense, amount: e.target.value })} />

                        </div>
                        <div>
                          <Label>Category</Label>
                          <Select value={newExpense.category} onValueChange={(value) => setNewExpense({ ...newExpense, category: value })}>
                            <SelectTrigger>
                              <SelectValue />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value="food">Food</SelectItem>
                              <SelectItem value="lodging">Lodging</SelectItem>
                              <SelectItem value="transport">Transport</SelectItem>
                              <SelectItem value="entertainment">Entertainment</SelectItem>
                              <SelectItem value="shopping">Shopping</SelectItem>
                              <SelectItem value="utilities">Utilities</SelectItem>
                              <SelectItem value="other">Other</SelectItem>
                            </SelectContent>
                          </Select>
                        </div>
                      </div>
                      <div>
                        <Label>Date</Label>
                        <Input
                          type="date"
                          value={newExpense.date}
                          onChange={(e) => setNewExpense({ ...newExpense, date: e.target.value })} />

                      </div>
                      <div>
                        <Label>Notes (optional)</Label>
                        <Textarea
                          placeholder="Add details..."
                          value={newExpense.notes}
                          onChange={(e) => setNewExpense({ ...newExpense, notes: e.target.value })} />

                      </div>
                      <div>
                        <Label>Receipt Photo (optional)</Label>
                        <div className="mt-2">
                          {newExpense.photo_url ?
                          <div className="relative">
                              <img src={newExpense.photo_url} alt="Receipt" className="w-full h-32 object-cover rounded-lg" />
                              <Button
                              variant="destructive"
                              size="icon"
                              className="absolute top-2 right-2"
                              onClick={() => setNewExpense({ ...newExpense, photo_url: "" })}>

                                <X className="w-4 h-4" />
                              </Button>
                            </div> :

                          <label className="flex items-center justify-center gap-2 p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-cyan-500 cursor-pointer transition-colors">
                              <input
                              type="file"
                              accept="image/*"
                              className="hidden"
                              onChange={handlePhotoUpload}
                              disabled={uploadingPhoto} />

                              {uploadingPhoto ?
                            <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-cyan-600" /> :

                            <>
                                  <ImageIcon className="w-5 h-5 text-gray-400" />
                                  <span className="text-sm text-gray-600">Upload Photo</span>
                                </>
                            }
                            </label>
                          }
                        </div>
                      </div>
                    </div>
                    <DialogFooter>
                      <Button onClick={handleAddExpense} disabled={!newExpense.title.trim() || !newExpense.amount}>
                        Add Expense
                      </Button>
                    </DialogFooter>
                  </DialogContent>
                </Dialog>
              </CardHeader>
              <CardContent>
                {expensesLoading ?
                <div className="space-y-3">
                    {[1, 2, 3].map((i) =>
                  <div key={i} className="h-20 bg-gray-100 animate-pulse rounded-xl" />
                  )}
                  </div> :
                expenses.length === 0 ?
                <div className="text-center py-12">
                    <Receipt className="w-16 h-16 mx-auto text-gray-300 mb-4" />
                    <p className="text-gray-500 mb-4">No expenses yet</p>
                    <Button onClick={() => setShowAddExpense(true)} className="bg-gradient-to-r from-cyan-500 to-blue-600">
                      Add First Expense
                    </Button>
                  </div> :

                <div className="space-y-3">
                    {expenses.map((expense, index) =>
                  <motion.div
                    key={expense.id}
                    initial={{ opacity: 0, y: 10 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ delay: index * 0.05 }}>

                        <Card className="hover:shadow-md transition-shadow border border-gray-100">
                          <CardContent className="p-4">
                            <div className="flex gap-4">
                              {expense.photo_url &&
                          <img src={expense.photo_url} alt="Receipt" className="w-16 h-16 object-cover rounded-lg" />
                          }
                              <div className="flex-1">
                                <div className="flex justify-between items-start mb-2">
                                  <div>
                                    <h3 className="font-semibold text-gray-900">{expense.title}</h3>
                                    <p className="text-sm text-gray-500">
                                      Paid by {expense.paid_by === user?.email ? 'you' : expense.paid_by}
                                    </p>
                                  </div>
                                  <div className="text-right">
                                    <p className="font-bold text-lg text-gray-900">${expense.amount.toFixed(2)}</p>
                                    <Badge className={categoryColors[expense.category]}>{expense.category}</Badge>
                                  </div>
                                </div>
                                <div className="flex items-center justify-between text-sm">
                                  <span className="text-gray-500">{new Date(expense.date).toLocaleDateString()}</span>
                                  {expense.notes &&
                              <span className="text-gray-400 text-xs">{expense.notes}</span>
                              }
                                </div>
                              </div>
                            </div>
                          </CardContent>
                        </Card>
                      </motion.div>
                  )}
                  </div>
                }
              </CardContent>
            </Card>
          </div>

          {/* Sidebar */}
          <div className="space-y-6">
            {/* Members */}
            <Card className="shadow-md border-0">
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Users className="w-5 h-5" />
                  Members
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-3">
                  {group.members?.map((email, index) =>
                  <div key={email} className="flex items-center gap-3">
                      <Avatar>
                        <AvatarFallback className="bg-gradient-to-br from-cyan-100 to-blue-100 text-cyan-700">
                          {email[0].toUpperCase()}
                        </AvatarFallback>
                      </Avatar>
                      <div className="flex-1">
                        <p className="font-medium text-sm">{email === user?.email ? 'You' : email}</p>
                      </div>
                    </div>
                  )}
                </div>
                <div className="mt-4 pt-4 border-t">
                  <Button
                    variant="outline"
                    className="w-full"
                    onClick={copyInviteCode}>

                    {copiedCode ?
                    <>
                        <Check className="w-4 h-4 mr-2" />
                        Copied!
                      </> :

                    <>
                        <Copy className="w-4 h-4 mr-2" />
                        Copy Invite Code
                      </>
                    }
                  </Button>
                  <p className="text-xs text-center text-gray-500 mt-2">
                    Code: {group.invite_code}
                  </p>
                </div>
              </CardContent>
            </Card>

            {/* Balances */}
            <Card className="shadow-md border-0">
              <CardHeader>
                <CardTitle>Your Balance</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-3">
                  {Object.entries(myBalance.owed).map(([email, amount]) =>
                  <div key={email} className="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                      <span className="text-sm">{email}</span>
                      <span className="font-semibold text-green-600">owes you ${amount.toFixed(2)}</span>
                    </div>
                  )}
                  {Object.entries(myBalance.owes).map(([email, amount]) =>
                  <div key={email} className="flex justify-between items-center p-3 bg-orange-50 rounded-lg">
                      <span className="text-sm">{email}</span>
                      <span className="font-semibold text-orange-600">you owe ${amount.toFixed(2)}</span>
                    </div>
                  )}
                  {Object.keys(myBalance.owed).length === 0 && Object.keys(myBalance.owes).length === 0 &&
                  <p className="text-center text-gray-500 text-sm py-4">All settled up! ðŸŽ‰</p>
                  }
                </div>
              </CardContent>
            </Card>
          </div>
        </div>
      </div>
    </div>);

}
